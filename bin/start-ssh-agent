#!/usr/bin/env sh

[ ! -d "$HOME/.ssh" ] && exit

agent_sock_file="$HOME/.ssh/agent_sock"
agent_pid_file="$HOME/.ssh/agent_pid"

start_agent() {
	eval `ssh-agent -s` > /dev/null
	echo $SSH_AUTH_SOCK > $agent_sock_file
	echo $SSH_AGENT_PID > $agent_pid_file

	echo "$SSH_AUTH_SOCK:$SSH_AGENT_PID"
}

clean_and_start_agent() {
	rm -f $agent_sock_file $agent_pid_file
	start_agent
}

if [ ! -f "$agent_pid_file" ] || [ ! -f "$agent_sock_file" ]; then
	ssh_agent_pid=$(ps -A | grep ssh-agent | awk '{print $1; exit}')
	[ ! -z $ssh_agent_pid ] && kill $ssh_agent_pid
	start_agent
	exit
else
	pid=$(cat $agent_pid_file)
	ps $pid > /dev/null
	if [ $? -ne 0 ]; then
		clean_and_start_agent
		exit
	fi

	sock=$(cat $agent_sock_file)
	if [ ! -S "$sock" ]; then
		clean_and_start_agent
		exit
	fi

	echo "$sock:$pid"
fi
